{% extends "base.html" %}
{% block content %}
<h2>ğŸ“¡ Ã‰tat du systÃ¨me</h2>

{# Infos utilisateur pour savoir si admin ou non #}
{% set user = session.get("user") %}
{% set role = user["role"] if user else "" %}
{% set is_admin = (role == "admin") %}

<!-- Carte : Ã©tat de la route (Freebox / 4G) -->
<div class="card status-card">
    {% set state = 'unknown' %}
    {% if 'Freebox' in gw_text %}
        {% set state = 'freebox' %}
    {% elif '4G' in gw_text %}
        {% set state = '4g' %}
    {% endif %}

    <div class="status-row">
        <div class="led led-{{ state }}"></div>
        <div>
            <div class="status-main">{{ gw_text }}</div>
            <div class="status-sub">Route par dÃ©faut actuelle</div>
        </div>
    </div>
</div>

<!-- Carte : signal 4G -->
<div class="card">
    <h3>Signal 4G (SIM7600E)</h3>
    <div class="signal-wrapper">
        <div class="signal-bar">
            <div class="signal-fill" style="width: {{ signal_percent }}%;"></div>
        </div>
        <div class="signal-text">{{ signal_text }} â€” {{ signal_percent }}%</div>
    </div>
</div>

<!-- Carte : actions rÃ©seau -->
<div class="card">
    <h3>Actions rÃ©seau</h3>
    <div class="btn-row">
        <a class="btn btn-primary" href="{{ url_for('sms') }}">ğŸ“¨ Test SMS</a>
        <a class="btn btn-warning" href="{{ url_for('reboot') }}">ğŸ“¡ Reboot modem 4G</a>
        <a class="btn btn-secondary" href="{{ url_for('test_failover') }}">ğŸ§ª Test failover</a>
    </div>
</div>

<!-- Carte : actions systÃ¨me -->
<div class="card">
    <h3>Actions systÃ¨me</h3>
    <div class="btn-row">
        <a class="btn btn-danger {% if not is_admin %}btn-disabled{% endif %}"
           href="{% if is_admin %}{{ url_for('reboot_pi') }}{% else %}#{% endif %}">
           ğŸ” Reboot Raspberry Pi
        </a>
    </div>
    {% if not is_admin %}
        <p style="font-size:0.8em;color:var(--muted);margin-top:6px;">
            (Reboot Pi rÃ©servÃ© aux administrateurs)
        </p>
    {% endif %}
</div>

<!-- Carte : historique Freebox / 4G -->
<div class="card">
    <h3>Historique Freebox / 4G</h3>
    <div class="chart-container">
        <canvas id="historyChart"></canvas>
    </div>
</div>

<!-- Carte : logs avec scroll, copy, toggle -->
<div class="card">
    <h3>Derniers logs</h3>

    <div class="log-toolbar">
        <button class="btn btn-secondary" onclick="toggleLogs()">ğŸ“‚ RÃ©duire / Ouvrir</button>
        <button class="btn btn-secondary" onclick="copyLogs()">ğŸ“‹ Copier tout</button>
    </div>

    <pre id="logbox" class="log-box">{{ logs | join("\n") }}</pre>
</div>

<!-- Chart.js pour lâ€™historique -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    // DonnÃ©es envoyÃ©es par routes.py (history_times / history_states)
    const times  = {{ history_times | tojson | safe }};
    const states = {{ history_states | tojson | safe }};

    if (times.length && states.length) {
        const ctx = document.getElementById("historyChart").getContext("2d");
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: times,
                datasets: [{
                    label: 'Ã‰tat rÃ©seau (1 = Freebox, 0 = 4G)',
                    data: states,
                    fill: true,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        min: 0,
                        max: 1,
                        ticks: {
                            stepSize: 1,
                            callback: (value) => value === 1 ? 'Freebox' : (value === 0 ? '4G' : value)
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
});
</script>
{% endblock %}
